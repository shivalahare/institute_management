{% extends "base.html" %}
{% load course_extras %}

{% block title %}{{ course.name }} - Institute Management System{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>{{ course.name }}</h1>
    <p>Course Code: {{ course.code }}</p>
</div>

<div class="course-actions">
    {% if user.is_admin %}
    <a href="{% url 'course_update' course.id %}" class="btn btn-warning">
        <i class="fas fa-edit"></i> Edit Course
    </a>
    <a href="{% url 'course_delete' course.id %}" class="btn btn-danger">
        <i class="fas fa-trash"></i> Delete Course
    </a>
    {% endif %}

    {% if user.is_admin or user.is_teacher %}
    <a href="{% url 'attendance_record_create' %}?course={{ course.id }}" class="btn btn-success">
        <i class="fas fa-clipboard-check"></i> Take Attendance
    </a>
    {% endif %}

    <a href="{% url 'course_list' %}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Back to Courses
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>Course Information</h3>
            </div>
            <div class="card-body">
                <div class="course-details">
                    <div class="detail-item">
                        <div class="detail-label">Course Name:</div>
                        <div class="detail-value">{{ course.name }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Course Code:</div>
                        <div class="detail-value">{{ course.code }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Credits:</div>
                        <div class="detail-value">{{ course.credits }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value">{{ course.description|default:"No description provided"|linebreaks }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created:</div>
                        <div class="detail-value">{{ course.created_at|date:"F d, Y" }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Updated:</div>
                        <div class="detail-value">{{ course.updated_at|date:"F d, Y" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Course Schedule</h3>
            </div>
            <div class="card-body">
                {% if schedules %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Room</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for schedule in schedules %}
                            <tr>
                                <td>{{ schedule.get_day_display }}</td>
                                <td>{{ schedule.start_time|time:"g:i A" }}</td>
                                <td>{{ schedule.end_time|time:"g:i A" }}</td>
                                <td>{{ schedule.room|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No schedule has been set for this course.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Enrolled Students</h3>
                {% if user.is_admin %}
                <a href="{% url 'enrollment_create' %}?course={{ course.id }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-user-plus"></i> Add Student
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if enrollments %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Enrollment Date</th>
                                <th>Status</th>
                                <th>Grade</th>
                                {% if user.is_admin or user.is_teacher %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                            <tr>
                                <td>{{ enrollment.student.student_id }}</td>
                                <td>{{ enrollment.student.user.get_full_name }}</td>
                                <td>{{ enrollment.enrollment_date }}</td>
                                <td>
                                    <span class="badge {% if enrollment.status == 'active' %}badge-success{% elif enrollment.status == 'completed' %}badge-info{% else %}badge-warning{% endif %}">
                                        {{ enrollment.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ enrollment.grade|default:"-" }}</td>
                                {% if user.is_admin or user.is_teacher %}
                                <td class="table-actions">
                                    <a href="{% url 'enrollment_update' enrollment.id %}" class="btn btn-sm btn-warning">
                                        <i class="fas fa-edit"></i> Update
                                    </a>
                                    {% if user.is_admin %}
                                    <a href="{% url 'enrollment_delete' enrollment.id %}" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i> Remove
                                    </a>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No students are enrolled in this course.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>Teachers</h3>
            </div>
            <div class="card-body">
                {% if course.teachers.all %}
                <div class="teacher-list">
                    {% for teacher in course.teachers.all %}
                    <div class="teacher-item">
                        <div class="teacher-avatar">
                            {% if teacher.user.profile_pic %}
                            <img src="{{ teacher.user.profile_pic.url }}" alt="{{ teacher.user.get_full_name }}">
                            {% else %}
                            <div class="avatar-placeholder">
                                {{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="teacher-info">
                            <h4>{{ teacher.user.get_full_name }}</h4>
                            <p class="teacher-id">ID: {{ teacher.teacher_id }}</p>
                            {% if teacher.qualification %}
                            <p class="teacher-qualification">{{ teacher.qualification }}</p>
                            {% endif %}
                            {% if teacher.experience %}
                            <p class="teacher-experience">{{ teacher.experience }} years experience</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No teachers assigned to this course.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Course Statistics</h3>
            </div>
            <div class="card-body">
                <div class="stat-item">
                    <div class="stat-label">Total Students:</div>
                    <div class="stat-value">{{ enrollments|length }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Students:</div>
                    <div class="stat-value">{{ enrollments|filter_active|length }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Completed:</div>
                    <div class="stat-value">{{ enrollments|filter_completed|length }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Dropped:</div>
                    <div class="stat-value">{{ enrollments|filter_dropped|length }}</div>
                </div>

                <div class="enrollment-chart-container">
                    <canvas id="enrollmentChart" width="100%" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Recent Attendance</h3>
                <div>
                    <a href="{% url 'attendance_record_list' %}?course={{ course.id }}" class="btn btn-sm btn-outline">
                        <i class="fas fa-list"></i> View All
                    </a>
                    {% if user.is_admin or user.is_teacher %}
                    <a href="{% url 'attendance_record_create' %}?course={{ course.id }}" class="btn btn-sm btn-success">
                        <i class="fas fa-clipboard-check"></i> Take Attendance
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if course.attendance_records.all %}
                <div class="attendance-list">
                    {% for record in course.attendance_records.all|slice:":5" %}
                    <div class="attendance-item">
                        <div class="attendance-date">
                            <span class="date">{{ record.date|date:"M d" }}</span>
                            <span class="year">{{ record.date|date:"Y" }}</span>
                        </div>
                        <div class="attendance-stats">
                            <div class="stat">
                                <span class="value">{{ record.student_attendances.count }}</span>
                                <span class="label">Total</span>
                            </div>
                            <div class="stat">
                                <span class="value">{{ record.date|date:"D" }}</span>
                                <span class="label">Day</span>
                            </div>
                            <div class="stat">
                                <span class="value"><i class="fas fa-eye"></i></span>
                                <span class="label">View</span>
                            </div>
                        </div>
                        <div class="attendance-actions">
                            <a href="{% url 'attendance_record_detail' record.id %}" class="btn btn-sm btn-outline">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.is_admin or user.is_teacher %}
                            <a href="{% url 'update_attendance' record.id %}" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if user.is_admin %}
                            <a href="{% url 'attendance_record_delete' record.id %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No attendance records for this course.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .course-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .course-details {
        display: flex;
        flex-direction: column;
    }

    .detail-item {
        display: flex;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
        padding-bottom: 1rem;
    }

    .detail-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
        padding-bottom: 0;
    }

    .detail-label {
        font-weight: 600;
        width: 150px;
        color: var(--gray-700);
    }

    .detail-value {
        flex: 1;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .badge-success {
        color: #fff;
        background-color: #2ecc71;
    }

    .badge-info {
        color: #fff;
        background-color: #3498db;
    }

    .badge-warning {
        color: #212529;
        background-color: #f39c12;
    }

    .empty-state {
        text-align: center;
        padding: 1.5rem;
        color: var(--gray-600);
    }

    .teacher-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .teacher-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .teacher-item:last-child {
        padding-bottom: 0;
        border-bottom: none;
    }

    .teacher-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        overflow: hidden;
    }

    .teacher-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 100%;
        height: 100%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.25rem;
    }

    .teacher-info {
        flex: 1;
    }

    .teacher-info h4 {
        margin: 0 0 0.25rem;
        font-size: 1.1rem;
    }

    .teacher-id, .teacher-qualification, .teacher-experience {
        margin: 0 0 0.25rem;
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .stat-item:last-child {
        margin-bottom: 1.5rem;
    }

    .stat-label {
        font-weight: 600;
        color: var(--gray-700);
    }

    .stat-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .enrollment-chart-container {
        height: 200px;
        margin-top: 1.5rem;
    }

    .attendance-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .attendance-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background-color: var(--gray-100);
        border-radius: var(--border-radius);
    }

    .attendance-date {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 60px;
        margin-right: 1rem;
    }

    .attendance-date .date {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    .attendance-date .year {
        font-size: 0.8rem;
        color: var(--gray-600);
    }

    .attendance-stats {
        display: flex;
        flex: 1;
        gap: 1rem;
    }

    .attendance-stats .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .attendance-stats .value {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .attendance-stats .label {
        font-size: 0.8rem;
        color: var(--gray-600);
    }

    .attendance-actions {
        margin-left: auto;
        display: flex;
        gap: 0.25rem;
    }

    .table-actions {
        white-space: nowrap;
    }

    .card-header div {
        display: flex;
        gap: 0.5rem;
    }
</style>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enrollment Chart
        const enrollmentCtx = document.getElementById('enrollmentChart').getContext('2d');

        // Count enrollments by status
        const activeCount = {{ enrollments|filter_active|length|default:0 }};
        const completedCount = {{ enrollments|filter_completed|length|default:0 }};
        const droppedCount = {{ enrollments|filter_dropped|length|default:0 }};

        const enrollmentData = {
            labels: ['Active', 'Completed', 'Dropped'],
            datasets: [{
                data: [activeCount, completedCount, droppedCount],
                backgroundColor: [
                    'rgba(46, 204, 113, 0.7)',  // Active - Green
                    'rgba(52, 152, 219, 0.7)',  // Completed - Blue
                    'rgba(243, 156, 18, 0.7)'   // Dropped - Yellow
                ],
                borderColor: [
                    'rgba(46, 204, 113, 1)',
                    'rgba(52, 152, 219, 1)',
                    'rgba(243, 156, 18, 1)'
                ],
                borderWidth: 1
            }]
        };

        new Chart(enrollmentCtx, {
            type: 'doughnut',
            data: enrollmentData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}
