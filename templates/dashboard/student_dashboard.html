{% extends "base.html" %}
{% load fee_extras %}

{% block title %}Student Dashboard - Institute Management System{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Student Dashboard</h1>
    <p>Welcome back, {{ user.get_full_name }}! Here's an overview of your academic progress.</p>
</div>

<div class="stats-grid">
    <div class="stat-card animate" data-animation="slide-in-up">
        <div class="stat-icon primary">
            <i class="fas fa-book"></i>
        </div>
        <div class="stat-content">
            <h3>{{ course_count }}</h3>
            <p>Enrolled Courses</p>
        </div>
    </div>

    <div class="stat-card animate" data-animation="slide-in-up">
        <div class="stat-icon success">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="stat-content">
            <h3>{{ attendance_stats.present|default:"0" }}</h3>
            <p>Present Days</p>
        </div>
    </div>

    <div class="stat-card animate" data-animation="slide-in-up">
        <div class="stat-icon danger">
            <i class="fas fa-calendar-times"></i>
        </div>
        <div class="stat-content">
            <h3>{{ attendance_stats.absent|default:"0" }}</h3>
            <p>Absent Days</p>
        </div>
    </div>

    <div class="stat-card animate" data-animation="slide-in-up">
        <div class="stat-icon warning">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-content">
            <h3>${{ total_pending|floatformat:2 }}</h3>
            <p>Pending Fees</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>My Courses</h3>
                <a href="{% url 'student_enrollments' %}" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Code</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                            <tr>
                                <td>{{ enrollment.course.name }}</td>
                                <td>{{ enrollment.course.code }}</td>
                                <td>
                                    <span class="badge {% if enrollment.status == 'active' %}badge-success{% elif enrollment.status == 'completed' %}badge-info{% else %}badge-warning{% endif %}">
                                        {{ enrollment.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">You are not enrolled in any courses.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Recent Attendance</h3>
                <a href="{% url 'student_attendance_report' %}" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Course</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in recent_attendance %}
                            <tr>
                                <td>{{ attendance.attendance_record.date }}</td>
                                <td>{{ attendance.attendance_record.course.name }}</td>
                                <td>
                                    <span class="badge {% if attendance.status == 'present' %}badge-success{% elif attendance.status == 'absent' %}badge-danger{% elif attendance.status == 'late' %}badge-warning{% else %}badge-info{% endif %}">
                                        {{ attendance.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No attendance records found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Attendance Overview</h3>
                <div class="attendance-percentage">
                    <span>Present Rate: {{ present_percentage|floatformat:1 }}%</span>
                </div>
            </div>
            <div class="chart-body">
                <canvas id="attendanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Fee Status</h3>
                <a href="{% url 'student_fee_list' %}" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div class="card-body">
                <div class="fee-stats">
                    <div class="fee-stat">
                        <h4>Total Fees</h4>
                        <p>${{ total_fees|floatformat:2 }}</p>
                    </div>
                    <div class="fee-stat">
                        <h4>Paid</h4>
                        <p>${{ total_paid|floatformat:2 }}</p>
                    </div>
                    <div class="fee-stat">
                        <h4>Pending</h4>
                        <p>${{ total_pending|floatformat:2 }}</p>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Payment Progress</span>
                        {% if total_fees > 0 %}
                        <span>{{ total_paid|div:total_fees|mul:100|floatformat:0 }}%</span>
                        {% else %}
                        <span>0%</span>
                        {% endif %}
                    </div>
                    <div class="progress">
                        {% if total_fees > 0 %}
                        <div class="progress-bar" style="width: {{ total_paid|div:total_fees|mul:100|floatformat:0 }}%"></div>
                        {% else %}
                        <div class="progress-bar" style="width: 0%"></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    <a href="{% url 'student_enrollments' %}" class="btn btn-primary">
                        <i class="fas fa-book"></i> View Courses
                    </a>
                    <a href="{% url 'student_attendance_report' %}" class="btn btn-success">
                        <i class="fas fa-clipboard-check"></i> Attendance Report
                    </a>
                    <a href="{% url 'student_fee_list' %}" class="btn btn-warning">
                        <i class="fas fa-money-bill-wave"></i> Fee Details
                    </a>
                    <a href="{% url 'profile' %}" class="btn btn-info">
                        <i class="fas fa-user-circle"></i> Update Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Attendance Chart
        const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');

        // Extract data from the context
        const attendanceData = {
            labels: ['Present', 'Absent', 'Late', 'Excused'],
            datasets: [{
                label: 'Attendance Status',
                data: [
                    {{ attendance_stats.present|default:"0" }},
                    {{ attendance_stats.absent|default:"0" }},
                    {{ attendance_stats.late|default:"0" }},
                    {{ attendance_stats.excused|default:"0" }}
                ],
                backgroundColor: [
                    'rgba(46, 204, 113, 0.7)',  // Present - Green
                    'rgba(231, 76, 60, 0.7)',   // Absent - Red
                    'rgba(243, 156, 18, 0.7)',  // Late - Yellow
                    'rgba(52, 152, 219, 0.7)'   // Excused - Blue
                ],
                borderColor: [
                    'rgba(46, 204, 113, 1)',
                    'rgba(231, 76, 60, 1)',
                    'rgba(243, 156, 18, 1)',
                    'rgba(52, 152, 219, 1)'
                ],
                borderWidth: 1
            }]
        };

        new Chart(attendanceCtx, {
            type: 'doughnut',
            data: attendanceData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Your Attendance Distribution'
                    }
                }
            }
        });
    });
</script>

<style>
    .attendance-percentage {
        background-color: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}
